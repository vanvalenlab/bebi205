

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Spot Detection &#8212; BEBi 205: Deep Learning for Biological Data</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/spot-detection';</script>
    <link rel="canonical" href="vanvalenlab.github.io/bebi205/notebooks/spot-detection.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Vision Models: Cell Segmentation" href="segmentation.html" />
    <link rel="prev" title="Vision Models" href="../vision-model-toc.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../syllabus.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/bebi205-logo.svg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/bebi205-logo.svg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../syllabus.html">
                    Syllabus
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../schedule.html">Course Schedule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Publicly Available Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compute-resources.html">Compute Resources</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../assignments/toc.html">Assignments</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/assignment-1.html">Assignment 1: Cell Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/assignment-2.html">Assignment 2: Preliminary Proposal and Dataset Exploration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/project-proposal.html">Assignment 3: Project Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/assignment-4a.html">Assignment 4a: Celltype classification redux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/assignment-4b.html">Assignment 4b: Masked proteins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/assignment-5.html">Assignment 5: Progress Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/final-presentation.html">Final Presentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/final-report.html">Final Report</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../notebooks-toc.html">Course Notebooks</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="data-science-in-python-key.html">Data Science in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="images.html">Images as Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="sequences-key.html">Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="linear-classifier-key.html">The Linear Classifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="tf-dataset-key.html">TensorFlow Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="tf-classifier.html">Image classification with TensorFlow</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimizer.html">Optimizers</a></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="../vision-model-toc.html">Vision Models</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Spot Detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="segmentation.html">Vision Models: Cell Segmentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/vanvalenlab/bebi205" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/vanvalenlab/bebi205/edit/master/bebi205/notebooks/spot-detection.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/vanvalenlab/bebi205/issues/new?title=Issue%20on%20page%20%2Fnotebooks/spot-detection.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/spot-detection.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spot Detection</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-dataset-object">Prepare dataset object</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-model">Prepare model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-model">Train Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-predictions">Generate predictions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#benchmark-model-performance">Benchmark model performance</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="spot-detection">
<h1>Spot Detection<a class="headerlink" href="#spot-detection" title="Permalink to this heading">#</a></h1>
<p>Last updated May 08, 2023</p>
<p><a class="reference external" href="https://colab.research.google.com/github/vanvalenlab/bebi205/blob/master/bebi205/notebooks/spot-detection.ipynb"><img alt="Open in Colab" src="https://img.shields.io/static/v1?logo=google-colab&amp;message=Open%20in%20colab&amp;color=blue&amp;label=%20&amp;labelColor=5c5c5c" /></a></p>
<p>In this section we will build a model that will detect beetle appendages in images of beetles. The training data is courtesy of the Parker lab at Caltech. The images of ants are annotated with coordinates for different types of appendages (head, abdomen, thorax, etc.)</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>tensorflow-addons<span class="w"> </span><span class="s2">&quot;deepcell==0.9.0&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">skimage</span>
<span class="kn">import</span> <span class="nn">skimage.exposure</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_addons</span> <span class="k">as</span> <span class="nn">tfa</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">sklearn.model_selection</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
</div>
<p>To solve this problem, we will treat it as a regression problem. For each image we will try to predict a transform image. This transform image will tell us how far each pixel is from the nearest spot. By looking for the extrema in the predicted transform image, we will be able to identify the appendages.</p>
<p>The transform we will use is</p>
<div class="amsmath math notranslate nohighlight" id="equation-5f4ab6f5-7a76-4d18-95b5-8530b8b66515">
<span class="eqno">(16)<a class="headerlink" href="#equation-5f4ab6f5-7a76-4d18-95b5-8530b8b66515" title="Permalink to this equation">#</a></span>\[\begin{equation}
transform = \frac{1}{1+\frac{distance}{\alpha}},
\end{equation}\]</div>
<p>where $\alpha$ is a parameter that determines the length scale. We will set $\alpha$ to be ~10 pixels, which is roughly the length scale for an appendage.</p>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this heading">#</a></h2>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>wget<span class="w"> </span>https://storage.googleapis.com/datasets-spring2021/bugs.npz
<span class="o">!</span>wget<span class="w"> </span>https://storage.googleapis.com/datasets-spring2021/bug_annotations.csv
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data and convert annotations to transform images</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.morphology</span> <span class="kn">import</span> <span class="n">distance_transform_edt</span>

<span class="c1"># We will compute the transforms for each set of annotations using the </span>
<span class="c1"># coord_to_dist function</span>
<span class="k">def</span> <span class="nf">coord_to_dist</span><span class="p">(</span><span class="n">point_list</span><span class="p">,</span>
                  <span class="n">image_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span><span class="mi">512</span><span class="p">),</span>
                  <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># create an image with 0 = pixel containing point </span>
    <span class="c1"># from point_list, 1 = pixel not containing point from point_list</span>
    <span class="n">contains_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">image_shape</span><span class="p">)</span> 

    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point_list</span><span class="p">):</span>
        <span class="n">nearest_pixel_y_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">dy</span><span class="p">))</span>
        <span class="n">nearest_pixel_x_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>
        <span class="n">contains_point</span><span class="p">[</span><span class="n">nearest_pixel_y_ind</span><span class="p">,</span> <span class="n">nearest_pixel_x_ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">edt</span><span class="p">,</span> <span class="n">inds</span> <span class="o">=</span> <span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">contains_point</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="p">[</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">])</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">edt</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">transform</span>

<span class="k">def</span> <span class="nf">load_bug_data</span><span class="p">():</span>
    <span class="n">bugs_path</span> <span class="o">=</span> <span class="s1">&#39;bugs.npz&#39;</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="s1">&#39;bug_annotations.csv&#39;</span>

    <span class="n">bug_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">bugs_path</span><span class="p">)</span>
    <span class="n">bug_imgs</span> <span class="o">=</span> <span class="n">bug_file</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">bug_imgs</span> <span class="o">/=</span> <span class="mf">255.0</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">bug_imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># Normalize bug images</span>
    <span class="n">bug_imgs_norm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">bug_imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">bug_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="n">bug_imgs_norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">bug_imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bug_imgs_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bug_imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">bug_imgs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Load annotations</span>
    <span class="n">csv_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
    <span class="n">csv_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

    <span class="n">head_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thorax_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">abdomen_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Convert point_lists to transform images</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">bug_imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="c1"># Load the annotation for the image</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;fileindex&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
        <span class="n">head_ann</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bodyparts&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;head&#39;</span><span class="p">][[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">256</span><span class="o">/</span><span class="mi">500</span>
        <span class="n">thorax_ann</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bodyparts&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;thorax&#39;</span><span class="p">][[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">256</span><span class="o">/</span><span class="mi">500</span>
        <span class="n">abdomen_ann</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bodyparts&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">256</span><span class="o">/</span><span class="mi">500</span>

        <span class="n">head_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">head_ann</span><span class="p">)</span>
        <span class="n">thorax_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thorax_ann</span><span class="p">)</span>
        <span class="n">abdomen_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">abdomen_ann</span><span class="p">)</span>

        <span class="c1"># Compute transforms</span>
        <span class="n">head_distance_img</span> <span class="o">=</span> <span class="n">coord_to_dist</span><span class="p">(</span><span class="n">head_ann</span><span class="p">,</span> <span class="n">image_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="n">thorax_distance_img</span> <span class="o">=</span> <span class="n">coord_to_dist</span><span class="p">(</span><span class="n">thorax_ann</span><span class="p">,</span> <span class="n">image_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="n">abdomen_distance_img</span> <span class="o">=</span> <span class="n">coord_to_dist</span><span class="p">(</span><span class="n">abdomen_ann</span><span class="p">,</span> <span class="n">image_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>

        <span class="n">head_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head_distance_img</span><span class="p">)</span>
        <span class="n">thorax_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thorax_distance_img</span><span class="p">)</span>
        <span class="n">abdomen_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abdomen_distance_img</span><span class="p">)</span>

    <span class="n">head_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">head_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">thorax_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">thorax_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">abdomen_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">abdomen_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">head_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">head_distance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">thorax_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">thorax_distance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">abdomen_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">abdomen_distance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">bug_imgs</span><span class="p">,</span> <span class="n">head_distance</span><span class="p">,</span> <span class="n">thorax_distance</span><span class="p">,</span> <span class="n">abdomen_distance</span>

<span class="n">bug_imgs</span><span class="p">,</span> <span class="n">head_distance</span><span class="p">,</span> <span class="n">thorax_distance</span><span class="p">,</span> <span class="n">abdomen_distance</span> <span class="o">=</span> <span class="n">load_bug_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(847, 500, 500)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visually inspect the images and transforms to make sure they are correct</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bug_imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">csv_path</span> <span class="o">=</span> <span class="s1">&#39;bug_annotations.csv&#39;</span>
<span class="n">csv_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ann</span> <span class="o">=</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;fileindex&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">index</span><span class="p">]</span>
<span class="n">head_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bodyparts&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;head&#39;</span><span class="p">][[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]])</span> <span class="o">*</span> <span class="mi">256</span><span class="o">/</span><span class="mi">500</span>
<span class="n">thorax_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bodyparts&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;thorax&#39;</span><span class="p">][[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]])</span> <span class="o">*</span> <span class="mi">256</span><span class="o">/</span><span class="mi">500</span>
<span class="n">abdomen_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bodyparts&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]])</span> <span class="o">*</span> <span class="mi">256</span><span class="o">/</span><span class="mi">500</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bug_imgs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">head_ann</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">head_ann</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">thorax_ann</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">thorax_ann</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">abdomen_ann</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">abdomen_ann</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">head_distance</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">head_ann</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">head_ann</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">thorax_distance</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">thorax_ann</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">thorax_ann</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">abdomen_distance</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">abdomen_ann</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">abdomen_ann</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(847, 256, 256, 1)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x7fa9ca535668&gt;
</pre></div>
</div>
<img alt="../_images/1a8c59182ac057cdf72a624812b69d9917e801db5a05c511a7d2fe97ba8839d4.png" src="../_images/1a8c59182ac057cdf72a624812b69d9917e801db5a05c511a7d2fe97ba8839d4.png" />
</div>
</div>
</section>
<section id="prepare-dataset-object">
<h2>Prepare dataset object<a class="headerlink" href="#prepare-dataset-object" title="Permalink to this heading">#</a></h2>
<p>Creating the dataset object is more challenging for this problem due to our problem framing. Because we are predicting the transform images, we need to make sure we apply the same transform to the raw image and the transform images. If we do not, then the information content of the transform images (e.g., where the appendages are) will be lost.</p>
<p>Doing this using tensorflow dataset objects is a little challenging. We will need to specify the augmentation operation that will be applied, and then specifically apply it to each of image (e.g., the raw image and each of the transform images). To specify the augmentation operation, we will need to specify the transform matrix. Moreover, this specification needs to be done with tensorflow objects (e.g., tensorflow tensors and operations from tf.image). These steps are executed in the following cell.</p>
<p>An additional practical programming note - because we are predicting 3 transforms, we will need a network that produces 3 prediction images. It can get confusing to keep track of which prediction image is which. To mitigate this, we will have our dataset object produce dictionaries rather than tuples or lists. The key names in the dictionary will match the names of the corresponding layers in the deep learning model. This will help us keep track of which transform image is which and what part of the model it should be paired with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create dataset object</span>

<span class="k">class</span> <span class="nc">BugDatasetBuilder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">X</span><span class="p">,</span>
                 <span class="n">y_head</span><span class="p">,</span>
                 <span class="n">y_abdomen</span><span class="p">,</span>
                 <span class="n">y_thorax</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">augmentation_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;zoom_range&#39;</span><span class="p">:(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">),</span>
                                      <span class="s1">&#39;horizontal_flip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="s1">&#39;vertical_flip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="s1">&#39;rotation_range&#39;</span><span class="p">:</span> <span class="mi">180</span><span class="p">}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_head</span> <span class="o">=</span> <span class="n">y_head</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_abdomen</span> <span class="o">=</span> <span class="n">y_abdomen</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_thorax</span> <span class="o">=</span> <span class="n">y_thorax</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmentation_kwargs</span> <span class="o">=</span> <span class="n">augmentation_kwargs</span>
        
        <span class="c1"># Create dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_dataset</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_transform_matrix_offset_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">o_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">o_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">offset_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">o_x</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">o_y</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">reset_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">o_x</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">o_y</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        
        <span class="n">offset_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">offset_matrix</span><span class="p">)</span>
        <span class="n">reset_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">reset_matrix</span><span class="p">)</span>
        
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">offset_matrix</span><span class="p">,</span> <span class="n">matrix</span><span class="p">),</span> <span class="n">reset_matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transform_matrix</span>
        
    <span class="k">def</span> <span class="nf">_compute_random_transform_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rotation_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augmentation_kwargs</span><span class="p">[</span><span class="s1">&#39;rotation_range&#39;</span><span class="p">]</span>
        <span class="n">zoom_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augmentation_kwargs</span><span class="p">[</span><span class="s1">&#39;zoom_range&#39;</span><span class="p">]</span>
        <span class="n">horizontal_flip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augmentation_kwargs</span><span class="p">[</span><span class="s1">&#39;horizontal_flip&#39;</span><span class="p">]</span>
        <span class="n">vertical_flip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augmentation_kwargs</span><span class="p">[</span><span class="s1">&#39;vertical_flip&#39;</span><span class="p">]</span>
        
        
        <span class="c1"># Get random angles</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> 
                                  <span class="n">minval</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rotation_range</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> 
                                  <span class="n">maxval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rotation_range</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
        <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        
        <span class="n">rot_row_0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">cos_theta</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_theta</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot_row_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">sin_theta</span><span class="p">,</span> <span class="n">cos_theta</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot_row_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rot_row_0</span><span class="p">,</span> <span class="n">rot_row_1</span><span class="p">,</span> <span class="n">rot_row_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">rotation_matrix</span>
        
        <span class="c1"># Get random lr flips</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">categorical</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]),</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;float32&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">lr_row_0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">lr</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lr_row_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lr_row_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lr_flip_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lr_row_0</span><span class="p">,</span> <span class="n">lr_row_1</span><span class="p">,</span> <span class="n">lr_row_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transform_matrix</span><span class="p">,</span> <span class="n">lr_flip_matrix</span><span class="p">)</span>
        
        <span class="c1"># Get randum ud flips</span>
        <span class="n">ud</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">categorical</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]),</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;float32&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">ud_row_0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ud_row_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">ud</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ud_row_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ud_flip_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ud_row_0</span><span class="p">,</span> <span class="n">ud_row_1</span><span class="p">,</span> <span class="n">ud_row_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transform_matrix</span><span class="p">,</span> <span class="n">ud_flip_matrix</span><span class="p">)</span>

        <span class="c1"># Get random zooms</span>
        <span class="n">zx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">minval</span><span class="o">=</span><span class="n">zoom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxval</span><span class="o">=</span><span class="n">zoom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">zy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">minval</span><span class="o">=</span><span class="n">zoom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxval</span><span class="o">=</span><span class="n">zoom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z_row_0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zx</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z_row_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zy</span><span class="p">,</span> <span class="n">zero</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z_row_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">zoom_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">z_row_0</span><span class="p">,</span> <span class="n">z_row_1</span><span class="p">,</span> <span class="n">z_row_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">transform_matrix</span><span class="p">,</span> <span class="n">zoom_matrix</span><span class="p">)</span>

        <span class="c1"># Combine all matrices</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_matrix_offset_center</span><span class="p">(</span><span class="n">transform_matrix</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transform_matrix</span>        
    
    <span class="k">def</span> <span class="nf">_augment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">X_dict</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_dict</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Compute random transform matrix    </span>
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_random_transform_matrix</span><span class="p">()</span>
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">transform_matrix</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">transform_matrix</span> <span class="o">=</span> <span class="n">transform_matrix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">X_dict</span><span class="p">:</span>
            <span class="n">X_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                              <span class="n">transform_matrix</span><span class="p">,</span>
                                              <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;BILINEAR&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">y_dict</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;BILINEAR&#39;</span> <span class="k">if</span> <span class="n">y_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;NEAREST&#39;</span>
            <span class="n">y_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                    <span class="n">transform_matrix</span><span class="p">,</span>
                                    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">interp</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">X_dict</span><span class="p">,</span> <span class="n">y_dict</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_create_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_temp</span><span class="p">,</span> <span class="n">y_head_train</span><span class="p">,</span> <span class="n">y_head_temp</span><span class="p">,</span> <span class="n">y_abdomen_train</span><span class="p">,</span> <span class="n">y_abdomen_temp</span><span class="p">,</span> <span class="n">y_thorax_train</span><span class="p">,</span> <span class="n">y_thorax_temp</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_abdomen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_thorax</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_head_val</span><span class="p">,</span> <span class="n">y_head_test</span><span class="p">,</span> <span class="n">y_abdomen_val</span><span class="p">,</span> <span class="n">y_abdomen_test</span><span class="p">,</span> <span class="n">y_thorax_val</span><span class="p">,</span> <span class="n">y_thorax_test</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">X_temp</span><span class="p">,</span> <span class="n">y_head_temp</span><span class="p">,</span> <span class="n">y_abdomen_temp</span><span class="p">,</span> <span class="n">y_thorax_temp</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">X_train_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="p">}</span>
        <span class="n">y_train_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="n">y_head_train</span><span class="p">,</span>
                        <span class="s1">&#39;abdomen&#39;</span><span class="p">:</span> <span class="n">y_abdomen_train</span><span class="p">,</span>
                        <span class="s1">&#39;thorax&#39;</span><span class="p">:</span> <span class="n">y_thorax_train</span><span class="p">}</span>
        
        <span class="n">X_val_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_val</span><span class="p">}</span>
        <span class="n">y_val_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="n">y_head_val</span><span class="p">,</span>
                      <span class="s1">&#39;abdomen&#39;</span><span class="p">:</span> <span class="n">y_abdomen_val</span><span class="p">,</span>
                      <span class="s1">&#39;thorax&#39;</span><span class="p">:</span> <span class="n">y_thorax_val</span><span class="p">}</span>
        
        <span class="n">X_test_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">}</span>
        <span class="n">y_test_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="n">y_head_test</span><span class="p">,</span>
                       <span class="s1">&#39;abdomen&#39;</span><span class="p">:</span> <span class="n">y_abdomen_test</span><span class="p">,</span>
                       <span class="s1">&#39;thorax&#39;</span><span class="p">:</span> <span class="n">y_thorax_test</span><span class="p">}</span>
        
        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">X_train_dict</span><span class="p">,</span> <span class="n">y_train_dict</span><span class="p">))</span>
        <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">X_val_dict</span><span class="p">,</span> <span class="n">y_val_dict</span><span class="p">))</span>
        <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">X_test_dict</span><span class="p">,</span> <span class="n">y_test_dict</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_augment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataset</span> <span class="o">=</span> <span class="n">val_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">bug_data</span> <span class="o">=</span> <span class="n">BugDatasetBuilder</span><span class="p">(</span><span class="n">bug_imgs</span><span class="p">,</span> <span class="n">head_distance</span><span class="p">,</span> <span class="n">abdomen_distance</span><span class="p">,</span> <span class="n">thorax_distance</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">X_dict</span><span class="p">,</span> <span class="n">y_dict</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">bug_data</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_dict</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_dict</span><span class="p">[</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_dict</span><span class="p">[</span><span class="s1">&#39;thorax&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/77b353ce99d5d224357a8ae373f914678309250690b80271b2deed9e42d69480.png" src="../_images/77b353ce99d5d224357a8ae373f914678309250690b80271b2deed9e42d69480.png" />
</div>
</div>
</section>
<section id="prepare-model">
<h2>Prepare model<a class="headerlink" href="#prepare-model" title="Permalink to this heading">#</a></h2>
<p>Next, we will need to make a model. Because we are doing image level prediction, our model choice also becomes a little more complicated. Our backbones will produce features at different scales, and we would like to use them to make dense, pixel level predictions. This requires us to both upsample feature maps and also integrate features across length scales. Lower level features contain fine spatial details while the higher level features contain contextual information - we would like to use both to make our prediction. While there are many approaches to doing so, the two most common are</p>
<ul class="simple">
<li><p>U-Nets: U-Nets upsample and concatenate to merge feature maps</p></li>
<li><p>Feature pyramids: Feature pyramids upsample and add to merge feature maps
The accuracy for each approaches are often similar, but feature pyramids are often faster and require less memory.</p></li>
</ul>
<p>The first step will be to extract the features from the backbone, which concretely means we need to extract the outputs of specific layers. See the <a class="reference external" href="https://github.com/vanvalenlab/deepcell-tf/blob/master/deepcell/utils/backbone_utils.py">get_backbone</a> function from the deepcell-tf repository for a more general implementation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_backbone</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">input_tensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">use_imagenet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">frames_per_batch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="c1"># Make sure backbone name is lower case</span>
    <span class="n">_backbone</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">backbone</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="c1"># List of acceptable backbones</span>
    <span class="n">resnet_backbones</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;resnet50&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">ResNet50</span><span class="p">,</span>
        <span class="s1">&#39;resnet101&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">ResNet101</span><span class="p">,</span>
        <span class="s1">&#39;resnet152&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">ResNet152</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="c1"># Create the input for the model</span>
    <span class="k">if</span> <span class="n">input_tensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img_input</span> <span class="o">=</span> <span class="n">input_tensor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_shape</span><span class="p">:</span>
            <span class="n">img_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    
    <span class="c1"># Grab the weights if we&#39;re using a model pre-trained</span>
    <span class="c1"># on imagenet</span>
    <span class="k">if</span> <span class="n">use_imagenet</span><span class="p">:</span>
        <span class="n">kwargs_with_weights</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs_with_weights</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">if</span> <span class="n">_backbone</span> <span class="ow">in</span> <span class="n">resnet_backbones</span><span class="p">:</span>
        <span class="n">model_cls</span> <span class="o">=</span> <span class="n">resnet_backbones</span><span class="p">[</span><span class="n">_backbone</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="n">input_tensor</span><span class="o">=</span><span class="n">img_input</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Set the weights of the model if requested</span>
        <span class="k">if</span> <span class="n">use_imagenet</span><span class="p">:</span>
            <span class="n">model_with_weights</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs_with_weights</span><span class="p">)</span>
            <span class="n">model_with_weights</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;model_weights.h5&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s1">&#39;model_weights.h5&#39;</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Define the names of the layers that have the desired features</span>
        <span class="k">if</span> <span class="n">_backbone</span> <span class="o">==</span> <span class="s1">&#39;resnet50&#39;</span><span class="p">:</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conv1_relu&#39;</span><span class="p">,</span> <span class="s1">&#39;conv2_block3_out&#39;</span><span class="p">,</span> <span class="s1">&#39;conv3_block4_out&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conv4_block6_out&#39;</span><span class="p">,</span> <span class="s1">&#39;conv5_block3_out&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">_backbone</span> <span class="o">==</span> <span class="s1">&#39;resnet101&#39;</span><span class="p">:</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conv1_relu&#39;</span><span class="p">,</span> <span class="s1">&#39;conv2_block3_out&#39;</span><span class="p">,</span> <span class="s1">&#39;conv3_block4_out&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conv4_block23_out&#39;</span><span class="p">,</span> <span class="s1">&#39;conv5_block3_out&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">_backbone</span> <span class="o">==</span> <span class="s1">&#39;resnet152&#39;</span><span class="p">:</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conv1_relu&#39;</span><span class="p">,</span> <span class="s1">&#39;conv2_block3_out&#39;</span><span class="p">,</span> <span class="s1">&#39;conv3_block8_out&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conv4_block36_out&#39;</span><span class="p">,</span> <span class="s1">&#39;conv5_block3_out&#39;</span><span class="p">]</span>
        
        <span class="c1"># Get layer outputs</span>
        <span class="n">layer_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ln</span><span class="p">)</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid value for `backbone`&#39;</span><span class="p">)</span>
        
    <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer_outputs</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_dict</span> <span class="k">else</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<p>With the ability to grab the features from the backbone, the next step is to merge features. Here, we will use a feature pyramid network.
<img alt="image.png" src="../_images/feature-pyramid.png" />
The recipe for how to merge a coarse and fine feature map is shown in the above figure. The coarse feature map is upsampled, while a 1x1 convolution is applied to the fine feature map. The result of each of these operations are then added together. This result is used as the coarse feature map for the next step of the pyramid. An implementation of functions to build feature pyramids starting from backbone features is the <a class="reference external" href="https://github.com/vanvalenlab/deepcell-tf/blob/master/deepcell/model_zoo/fpn.py">create_pyramid_features</a> function in deepcell_tf.</p>
<p>Backbone features are typically described using the nomenclature C[n], where n denotes the backbone level. Level n denotes downsampling by $\frac{1}{2^n}$. For example, C3 backbone feature maps would have 1/8th the size of the input image. Feature pyramids typically use features from C3, C4, and C5. The pyramid features of the corresponding level are described as P[n]. The pyramid features derived from C3-C5 are typically P3-P7. Pyramid levels P6 and P7 are created with convolutions of stride 2 of the coarsest backbone feature map.</p>
<p>Note that the typical feature pyramid doesnt produce feature maps that are the same size of the original image (P3 is 1/8th the size of the input image) - this means we cant use them to make our pixel-level predictions. To produce correctly sized feature maps, we can upsample the top feature of the feature pyramid using a sequence of upsampling and convolution layers. We could also just add more pyramid levels (e.g. P2, P1, and P0), but this would be computationally more expensive. This sequence of upsampling and convolutions can be viewed as a separate submodel called a head. We can attach three of these heads to our feature pyramid - one for each prediction we hope to make (head, abdomen, and thorax).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">deepcell.layers</span> <span class="kn">import</span> <span class="n">ImageNormalization2D</span><span class="p">,</span> <span class="n">Location2D</span>
<span class="kn">from</span> <span class="nn">deepcell.model_zoo.fpn</span> <span class="kn">import</span> <span class="n">__create_pyramid_features</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">Activation</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">deepcell.utils.misc_utils</span> <span class="kn">import</span> <span class="n">get_sorted_keys</span>
<span class="kn">from</span> <span class="nn">deepcell.model_zoo.fpn</span> <span class="kn">import</span> <span class="n">semantic_upsample</span>

<span class="k">def</span> <span class="nf">__create_semantic_head</span><span class="p">(</span><span class="n">pyramid_dict</span><span class="p">,</span>
                           <span class="n">input_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                           <span class="n">n_filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                           <span class="n">n_dense</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                           <span class="n">semantic_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;prediction_head&#39;</span><span class="p">,</span>
                           <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">target_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">upsample_type</span><span class="o">=</span><span class="s1">&#39;upsampling2d&#39;</span><span class="p">,</span>
                           <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a semantic head from a feature pyramid network.</span>
<span class="sd">    Args:</span>
<span class="sd">        pyramid_dict (dict): Dictionary of pyramid names and features.</span>
<span class="sd">        input_target (tensor): Optional tensor with the input image.</span>
<span class="sd">        n_classes (int): The number of classes to be predicted.</span>
<span class="sd">        n_filters (int): The number of convolutional filters.</span>
<span class="sd">        n_dense (int): Number of dense filters.</span>
<span class="sd">        semantic_id (int): ID of the semantic head.</span>
<span class="sd">        ndim (int): The spatial dimensions of the input data.</span>
<span class="sd">            Must be either 2 or 3.</span>
<span class="sd">        include_top (bool): Whether to include the final layer of the model</span>
<span class="sd">        target_level (int): The level we need to reach. Performs</span>
<span class="sd">            2x upsampling until we&#39;re at the target level.</span>
<span class="sd">        upsample_type (str): Choice of upsampling layer to use from</span>
<span class="sd">            ``[&#39;upsamplelike&#39;, &#39;upsampling2d&#39;, &#39;upsampling3d&#39;]``.</span>
<span class="sd">        interpolation (str): Choice of interpolation mode for upsampling</span>
<span class="sd">            layers from ``[&#39;bilinear&#39;, &#39;nearest&#39;]``.</span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: ``interpolation`` not in ``[&#39;bilinear&#39;, &#39;nearest&#39;]``</span>
<span class="sd">        ValueError: ``upsample_type`` not in</span>
<span class="sd">            ``[&#39;upsamplelike&#39;,&#39;upsampling2d&#39;, &#39;upsampling3d&#39;]``</span>
<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.keras.Layer: The semantic segmentation head</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check input to interpolation</span>
    <span class="n">acceptable_interpolation</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_interpolation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Interpolation mode &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported. &#39;</span>
                         <span class="s1">&#39;Choose from </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">interpolation</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">acceptable_interpolation</span><span class="p">)))</span>

    <span class="c1"># Check input to upsample_type</span>
    <span class="n">acceptable_upsample</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;upsamplelike&#39;</span><span class="p">,</span> <span class="s1">&#39;upsampling2d&#39;</span><span class="p">,</span> <span class="s1">&#39;upsampling3d&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">upsample_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_upsample</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Upsample method &quot;</span><span class="si">{}</span><span class="s1">&quot; not supported. &#39;</span>
                         <span class="s1">&#39;Choose from </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">upsample_type</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">acceptable_upsample</span><span class="p">)))</span>

    <span class="c1"># Check that there is an input_target if upsamplelike is used</span>
    <span class="k">if</span> <span class="n">upsample_type</span> <span class="o">==</span> <span class="s1">&#39;upsamplelike&#39;</span> <span class="ow">and</span> <span class="n">input_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;upsamplelike requires an input_target.&#39;</span><span class="p">)</span>

    <span class="n">conv</span> <span class="o">=</span> <span class="n">Conv2D</span> 
    <span class="n">conv_kernel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">channel_axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">n_classes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">include_top</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Get pyramid names and features into list form</span>
    <span class="n">pyramid_names</span> <span class="o">=</span> <span class="n">get_sorted_keys</span><span class="p">(</span><span class="n">pyramid_dict</span><span class="p">)</span>
    <span class="n">pyramid_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyramid_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pyramid_names</span><span class="p">]</span>

    <span class="c1"># Reverse pyramid names and features</span>
    <span class="n">pyramid_names</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">pyramid_features</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">pyramid_features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Perform upsampling</span>
    <span class="n">n_upsample</span> <span class="o">=</span> <span class="n">target_level</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">semantic_upsample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_upsample</span><span class="p">,</span>
                          <span class="n">target</span><span class="o">=</span><span class="n">input_target</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">upsample_type</span><span class="o">=</span><span class="n">upsample_type</span><span class="p">,</span> <span class="n">semantic_id</span><span class="o">=</span><span class="n">semantic_id</span><span class="p">,</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_dense</span><span class="p">,</span> <span class="n">conv_kernel</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_0_semantic_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">semantic_id</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">channel_axis</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;batch_normalization_0_semantic_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">semantic_id</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;relu_0_semantic_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">semantic_id</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Apply conv and softmax layer</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">conv_kernel</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> 
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1_semantic_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">semantic_id</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_top</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Softmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">channel_axis</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">K</span><span class="o">.</span><span class="n">floatx</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">output_name</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="n">K</span><span class="o">.</span><span class="n">floatx</span><span class="p">(),</span>
                       <span class="n">name</span><span class="o">=</span><span class="n">output_name</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">BugModel</span><span class="p">(</span><span class="n">backbone</span><span class="o">=</span><span class="s1">&#39;ResNet50&#39;</span><span class="p">,</span>
             <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">backbone_levels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;C5&#39;</span><span class="p">],</span>
             <span class="n">pyramid_levels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P3&#39;</span><span class="p">,</span> <span class="s1">&#39;P4&#39;</span><span class="p">,</span> <span class="s1">&#39;P5&#39;</span><span class="p">,</span> <span class="s1">&#39;P6&#39;</span><span class="p">,</span> <span class="s1">&#39;P7&#39;</span><span class="p">],</span>
             <span class="n">create_pyramid_features</span><span class="o">=</span><span class="n">__create_pyramid_features</span><span class="p">,</span>
             <span class="n">create_semantic_head</span><span class="o">=</span><span class="n">__create_semantic_head</span><span class="p">,</span>
             <span class="n">required_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
             <span class="n">norm_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">pooling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">location</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">use_imagenet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">lite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">upsample_type</span><span class="o">=</span><span class="s1">&#39;upsampling2d&#39;</span><span class="p">,</span>
             <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span>
             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bug_model&#39;</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
        
    <span class="c1"># Normalize input images</span>
    <span class="k">if</span> <span class="n">norm_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalization2D</span><span class="p">(</span><span class="n">norm_method</span><span class="o">=</span><span class="n">norm_method</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
        
    <span class="c1"># Add location layer - this breaks translational equivariance</span>
    <span class="c1"># but provides a notion of location to the model that can help</span>
    <span class="c1"># improve performance</span>
    <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">Location2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">)(</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">concat</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;concat_location&#39;</span><span class="p">)([</span><span class="n">norm</span><span class="p">,</span> <span class="n">loc</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">concat</span> <span class="o">=</span> <span class="n">norm</span>
        
    <span class="c1"># Force the channel size for the backbone input to be &#39;required_channels&#39;</span>
    <span class="n">fixed_inputs</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">required_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_channels&#39;</span><span class="p">)(</span><span class="n">concat</span><span class="p">)</span>

    <span class="c1"># Force the input shape</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">fixed_input_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">fixed_input_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">required_channels</span>
    <span class="n">fixed_input_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fixed_input_shape</span><span class="p">)</span>
    
    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;include_top&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="n">fixed_input_shape</span><span class="p">,</span>
        <span class="s1">&#39;pooling&#39;</span><span class="p">:</span> <span class="n">pooling</span>
    <span class="p">}</span>

    <span class="c1"># Get the backbone features</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">backbone_dict</span> <span class="o">=</span> <span class="n">get_backbone</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">fixed_inputs</span><span class="p">,</span>
                                    <span class="n">use_imagenet</span><span class="o">=</span><span class="n">use_imagenet</span><span class="p">,</span>
                                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

    <span class="n">backbone_dict_reduced</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">backbone_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">backbone_dict</span>
                             <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">backbone_levels</span><span class="p">}</span>
    
    <span class="n">ndim</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="c1"># Create the feature pyramid and get the relevant features</span>
    <span class="n">pyramid_dict</span> <span class="o">=</span> <span class="n">create_pyramid_features</span><span class="p">(</span><span class="n">backbone_dict_reduced</span><span class="p">,</span>
                                           <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span>
                                           <span class="n">lite</span><span class="o">=</span><span class="n">lite</span><span class="p">,</span>
                                           <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                                           <span class="n">upsample_type</span><span class="o">=</span><span class="n">upsample_type</span><span class="p">,</span>
                                           <span class="n">z_axis_convolutions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyramid_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pyramid_levels</span><span class="p">]</span>
    
    <span class="c1"># Figure out how much upsampling is required (e.g., if the top layer </span>
    <span class="c1"># is P3, then a 8X upsample is required)</span>
    <span class="n">semantic_levels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pyramid_dict</span><span class="p">]</span>
    <span class="n">target_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">semantic_levels</span><span class="p">)</span>
    
    <span class="c1"># Create the heads that perform upsampling to perform the final prediction</span>
    <span class="n">prediction_head_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">head_head</span> <span class="o">=</span> <span class="n">create_semantic_head</span><span class="p">(</span><span class="n">pyramid_dict</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">input_target</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">target_level</span><span class="o">=</span><span class="n">target_level</span><span class="p">,</span> <span class="n">semantic_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span> <span class="n">upsample_type</span><span class="o">=</span><span class="n">upsample_type</span><span class="p">,</span>
                                     <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">abdomen_head</span> <span class="o">=</span> <span class="n">create_semantic_head</span><span class="p">(</span><span class="n">pyramid_dict</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">input_target</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">target_level</span><span class="o">=</span><span class="n">target_level</span><span class="p">,</span> <span class="n">semantic_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;abdomen&#39;</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span> <span class="n">upsample_type</span><span class="o">=</span><span class="n">upsample_type</span><span class="p">,</span>
                                     <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thorax_head</span> <span class="o">=</span> <span class="n">create_semantic_head</span><span class="p">(</span><span class="n">pyramid_dict</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">input_target</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">target_level</span><span class="o">=</span><span class="n">target_level</span><span class="p">,</span> <span class="n">semantic_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                     <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;thorax&#39;</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span> <span class="n">upsample_type</span><span class="o">=</span><span class="n">upsample_type</span><span class="p">,</span>
                                     <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">head_head</span><span class="p">,</span> <span class="n">abdomen_head</span><span class="p">,</span> <span class="n">thorax_head</span><span class="p">]</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bug_model</span> <span class="o">=</span> <span class="n">BugModel</span><span class="p">()</span>
<span class="n">bug_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;bug_model&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
X (InputLayer)                  [(None, 256, 256, 1) 0                                            
__________________________________________________________________________________________________
location (Location2D)           (None, None, None, 2 0           X[0][0]                          
__________________________________________________________________________________________________
concat_location (Concatenate)   (None, 256, 256, 3)  0           X[0][0]                          
                                                                 location[0][0]                   
__________________________________________________________________________________________________
conv_channels (Conv2D)          (None, 256, 256, 3)  12          concat_location[0][0]            
__________________________________________________________________________________________________
conv1_pad (ZeroPadding2D)       (None, 262, 262, 3)  0           conv_channels[0][0]              
__________________________________________________________________________________________________
conv1_conv (Conv2D)             (None, 128, 128, 64) 9472        conv1_pad[0][0]                  
__________________________________________________________________________________________________
conv1_bn (BatchNormalization)   (None, 128, 128, 64) 256         conv1_conv[0][0]                 
__________________________________________________________________________________________________
conv1_relu (Activation)         (None, 128, 128, 64) 0           conv1_bn[0][0]                   
__________________________________________________________________________________________________
pool1_pad (ZeroPadding2D)       (None, 130, 130, 64) 0           conv1_relu[0][0]                 
__________________________________________________________________________________________________
pool1_pool (MaxPooling2D)       (None, 64, 64, 64)   0           pool1_pad[0][0]                  
__________________________________________________________________________________________________
conv2_block1_1_conv (Conv2D)    (None, 64, 64, 64)   4160        pool1_pool[0][0]                 
__________________________________________________________________________________________________
conv2_block1_1_bn (BatchNormali (None, 64, 64, 64)   256         conv2_block1_1_conv[0][0]        
__________________________________________________________________________________________________
conv2_block1_1_relu (Activation (None, 64, 64, 64)   0           conv2_block1_1_bn[0][0]          
__________________________________________________________________________________________________
conv2_block1_2_conv (Conv2D)    (None, 64, 64, 64)   36928       conv2_block1_1_relu[0][0]        
__________________________________________________________________________________________________
conv2_block1_2_bn (BatchNormali (None, 64, 64, 64)   256         conv2_block1_2_conv[0][0]        
__________________________________________________________________________________________________
conv2_block1_2_relu (Activation (None, 64, 64, 64)   0           conv2_block1_2_bn[0][0]          
__________________________________________________________________________________________________
conv2_block1_0_conv (Conv2D)    (None, 64, 64, 256)  16640       pool1_pool[0][0]                 
__________________________________________________________________________________________________
conv2_block1_3_conv (Conv2D)    (None, 64, 64, 256)  16640       conv2_block1_2_relu[0][0]        
__________________________________________________________________________________________________
conv2_block1_0_bn (BatchNormali (None, 64, 64, 256)  1024        conv2_block1_0_conv[0][0]        
__________________________________________________________________________________________________
conv2_block1_3_bn (BatchNormali (None, 64, 64, 256)  1024        conv2_block1_3_conv[0][0]        
__________________________________________________________________________________________________
conv2_block1_add (Add)          (None, 64, 64, 256)  0           conv2_block1_0_bn[0][0]          
                                                                 conv2_block1_3_bn[0][0]          
__________________________________________________________________________________________________
conv2_block1_out (Activation)   (None, 64, 64, 256)  0           conv2_block1_add[0][0]           
__________________________________________________________________________________________________
conv2_block2_1_conv (Conv2D)    (None, 64, 64, 64)   16448       conv2_block1_out[0][0]           
__________________________________________________________________________________________________
conv2_block2_1_bn (BatchNormali (None, 64, 64, 64)   256         conv2_block2_1_conv[0][0]        
__________________________________________________________________________________________________
conv2_block2_1_relu (Activation (None, 64, 64, 64)   0           conv2_block2_1_bn[0][0]          
__________________________________________________________________________________________________
conv2_block2_2_conv (Conv2D)    (None, 64, 64, 64)   36928       conv2_block2_1_relu[0][0]        
__________________________________________________________________________________________________
conv2_block2_2_bn (BatchNormali (None, 64, 64, 64)   256         conv2_block2_2_conv[0][0]        
__________________________________________________________________________________________________
conv2_block2_2_relu (Activation (None, 64, 64, 64)   0           conv2_block2_2_bn[0][0]          
__________________________________________________________________________________________________
conv2_block2_3_conv (Conv2D)    (None, 64, 64, 256)  16640       conv2_block2_2_relu[0][0]        
__________________________________________________________________________________________________
conv2_block2_3_bn (BatchNormali (None, 64, 64, 256)  1024        conv2_block2_3_conv[0][0]        
__________________________________________________________________________________________________
conv2_block2_add (Add)          (None, 64, 64, 256)  0           conv2_block1_out[0][0]           
                                                                 conv2_block2_3_bn[0][0]          
__________________________________________________________________________________________________
conv2_block2_out (Activation)   (None, 64, 64, 256)  0           conv2_block2_add[0][0]           
__________________________________________________________________________________________________
conv2_block3_1_conv (Conv2D)    (None, 64, 64, 64)   16448       conv2_block2_out[0][0]           
__________________________________________________________________________________________________
conv2_block3_1_bn (BatchNormali (None, 64, 64, 64)   256         conv2_block3_1_conv[0][0]        
__________________________________________________________________________________________________
conv2_block3_1_relu (Activation (None, 64, 64, 64)   0           conv2_block3_1_bn[0][0]          
__________________________________________________________________________________________________
conv2_block3_2_conv (Conv2D)    (None, 64, 64, 64)   36928       conv2_block3_1_relu[0][0]        
__________________________________________________________________________________________________
conv2_block3_2_bn (BatchNormali (None, 64, 64, 64)   256         conv2_block3_2_conv[0][0]        
__________________________________________________________________________________________________
conv2_block3_2_relu (Activation (None, 64, 64, 64)   0           conv2_block3_2_bn[0][0]          
__________________________________________________________________________________________________
conv2_block3_3_conv (Conv2D)    (None, 64, 64, 256)  16640       conv2_block3_2_relu[0][0]        
__________________________________________________________________________________________________
conv2_block3_3_bn (BatchNormali (None, 64, 64, 256)  1024        conv2_block3_3_conv[0][0]        
__________________________________________________________________________________________________
conv2_block3_add (Add)          (None, 64, 64, 256)  0           conv2_block2_out[0][0]           
                                                                 conv2_block3_3_bn[0][0]          
__________________________________________________________________________________________________
conv2_block3_out (Activation)   (None, 64, 64, 256)  0           conv2_block3_add[0][0]           
__________________________________________________________________________________________________
conv3_block1_1_conv (Conv2D)    (None, 32, 32, 128)  32896       conv2_block3_out[0][0]           
__________________________________________________________________________________________________
conv3_block1_1_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block1_1_conv[0][0]        
__________________________________________________________________________________________________
conv3_block1_1_relu (Activation (None, 32, 32, 128)  0           conv3_block1_1_bn[0][0]          
__________________________________________________________________________________________________
conv3_block1_2_conv (Conv2D)    (None, 32, 32, 128)  147584      conv3_block1_1_relu[0][0]        
__________________________________________________________________________________________________
conv3_block1_2_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block1_2_conv[0][0]        
__________________________________________________________________________________________________
conv3_block1_2_relu (Activation (None, 32, 32, 128)  0           conv3_block1_2_bn[0][0]          
__________________________________________________________________________________________________
conv3_block1_0_conv (Conv2D)    (None, 32, 32, 512)  131584      conv2_block3_out[0][0]           
__________________________________________________________________________________________________
conv3_block1_3_conv (Conv2D)    (None, 32, 32, 512)  66048       conv3_block1_2_relu[0][0]        
__________________________________________________________________________________________________
conv3_block1_0_bn (BatchNormali (None, 32, 32, 512)  2048        conv3_block1_0_conv[0][0]        
__________________________________________________________________________________________________
conv3_block1_3_bn (BatchNormali (None, 32, 32, 512)  2048        conv3_block1_3_conv[0][0]        
__________________________________________________________________________________________________
conv3_block1_add (Add)          (None, 32, 32, 512)  0           conv3_block1_0_bn[0][0]          
                                                                 conv3_block1_3_bn[0][0]          
__________________________________________________________________________________________________
conv3_block1_out (Activation)   (None, 32, 32, 512)  0           conv3_block1_add[0][0]           
__________________________________________________________________________________________________
conv3_block2_1_conv (Conv2D)    (None, 32, 32, 128)  65664       conv3_block1_out[0][0]           
__________________________________________________________________________________________________
conv3_block2_1_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block2_1_conv[0][0]        
__________________________________________________________________________________________________
conv3_block2_1_relu (Activation (None, 32, 32, 128)  0           conv3_block2_1_bn[0][0]          
__________________________________________________________________________________________________
conv3_block2_2_conv (Conv2D)    (None, 32, 32, 128)  147584      conv3_block2_1_relu[0][0]        
__________________________________________________________________________________________________
conv3_block2_2_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block2_2_conv[0][0]        
__________________________________________________________________________________________________
conv3_block2_2_relu (Activation (None, 32, 32, 128)  0           conv3_block2_2_bn[0][0]          
__________________________________________________________________________________________________
conv3_block2_3_conv (Conv2D)    (None, 32, 32, 512)  66048       conv3_block2_2_relu[0][0]        
__________________________________________________________________________________________________
conv3_block2_3_bn (BatchNormali (None, 32, 32, 512)  2048        conv3_block2_3_conv[0][0]        
__________________________________________________________________________________________________
conv3_block2_add (Add)          (None, 32, 32, 512)  0           conv3_block1_out[0][0]           
                                                                 conv3_block2_3_bn[0][0]          
__________________________________________________________________________________________________
conv3_block2_out (Activation)   (None, 32, 32, 512)  0           conv3_block2_add[0][0]           
__________________________________________________________________________________________________
conv3_block3_1_conv (Conv2D)    (None, 32, 32, 128)  65664       conv3_block2_out[0][0]           
__________________________________________________________________________________________________
conv3_block3_1_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block3_1_conv[0][0]        
__________________________________________________________________________________________________
conv3_block3_1_relu (Activation (None, 32, 32, 128)  0           conv3_block3_1_bn[0][0]          
__________________________________________________________________________________________________
conv3_block3_2_conv (Conv2D)    (None, 32, 32, 128)  147584      conv3_block3_1_relu[0][0]        
__________________________________________________________________________________________________
conv3_block3_2_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block3_2_conv[0][0]        
__________________________________________________________________________________________________
conv3_block3_2_relu (Activation (None, 32, 32, 128)  0           conv3_block3_2_bn[0][0]          
__________________________________________________________________________________________________
conv3_block3_3_conv (Conv2D)    (None, 32, 32, 512)  66048       conv3_block3_2_relu[0][0]        
__________________________________________________________________________________________________
conv3_block3_3_bn (BatchNormali (None, 32, 32, 512)  2048        conv3_block3_3_conv[0][0]        
__________________________________________________________________________________________________
conv3_block3_add (Add)          (None, 32, 32, 512)  0           conv3_block2_out[0][0]           
                                                                 conv3_block3_3_bn[0][0]          
__________________________________________________________________________________________________
conv3_block3_out (Activation)   (None, 32, 32, 512)  0           conv3_block3_add[0][0]           
__________________________________________________________________________________________________
conv3_block4_1_conv (Conv2D)    (None, 32, 32, 128)  65664       conv3_block3_out[0][0]           
__________________________________________________________________________________________________
conv3_block4_1_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block4_1_conv[0][0]        
__________________________________________________________________________________________________
conv3_block4_1_relu (Activation (None, 32, 32, 128)  0           conv3_block4_1_bn[0][0]          
__________________________________________________________________________________________________
conv3_block4_2_conv (Conv2D)    (None, 32, 32, 128)  147584      conv3_block4_1_relu[0][0]        
__________________________________________________________________________________________________
conv3_block4_2_bn (BatchNormali (None, 32, 32, 128)  512         conv3_block4_2_conv[0][0]        
__________________________________________________________________________________________________
conv3_block4_2_relu (Activation (None, 32, 32, 128)  0           conv3_block4_2_bn[0][0]          
__________________________________________________________________________________________________
conv3_block4_3_conv (Conv2D)    (None, 32, 32, 512)  66048       conv3_block4_2_relu[0][0]        
__________________________________________________________________________________________________
conv3_block4_3_bn (BatchNormali (None, 32, 32, 512)  2048        conv3_block4_3_conv[0][0]        
__________________________________________________________________________________________________
conv3_block4_add (Add)          (None, 32, 32, 512)  0           conv3_block3_out[0][0]           
                                                                 conv3_block4_3_bn[0][0]          
__________________________________________________________________________________________________
conv3_block4_out (Activation)   (None, 32, 32, 512)  0           conv3_block4_add[0][0]           
__________________________________________________________________________________________________
conv4_block1_1_conv (Conv2D)    (None, 16, 16, 256)  131328      conv3_block4_out[0][0]           
__________________________________________________________________________________________________
conv4_block1_1_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block1_1_conv[0][0]        
__________________________________________________________________________________________________
conv4_block1_1_relu (Activation (None, 16, 16, 256)  0           conv4_block1_1_bn[0][0]          
__________________________________________________________________________________________________
conv4_block1_2_conv (Conv2D)    (None, 16, 16, 256)  590080      conv4_block1_1_relu[0][0]        
__________________________________________________________________________________________________
conv4_block1_2_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block1_2_conv[0][0]        
__________________________________________________________________________________________________
conv4_block1_2_relu (Activation (None, 16, 16, 256)  0           conv4_block1_2_bn[0][0]          
__________________________________________________________________________________________________
conv4_block1_0_conv (Conv2D)    (None, 16, 16, 1024) 525312      conv3_block4_out[0][0]           
__________________________________________________________________________________________________
conv4_block1_3_conv (Conv2D)    (None, 16, 16, 1024) 263168      conv4_block1_2_relu[0][0]        
__________________________________________________________________________________________________
conv4_block1_0_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block1_0_conv[0][0]        
__________________________________________________________________________________________________
conv4_block1_3_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block1_3_conv[0][0]        
__________________________________________________________________________________________________
conv4_block1_add (Add)          (None, 16, 16, 1024) 0           conv4_block1_0_bn[0][0]          
                                                                 conv4_block1_3_bn[0][0]          
__________________________________________________________________________________________________
conv4_block1_out (Activation)   (None, 16, 16, 1024) 0           conv4_block1_add[0][0]           
__________________________________________________________________________________________________
conv4_block2_1_conv (Conv2D)    (None, 16, 16, 256)  262400      conv4_block1_out[0][0]           
__________________________________________________________________________________________________
conv4_block2_1_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block2_1_conv[0][0]        
__________________________________________________________________________________________________
conv4_block2_1_relu (Activation (None, 16, 16, 256)  0           conv4_block2_1_bn[0][0]          
__________________________________________________________________________________________________
conv4_block2_2_conv (Conv2D)    (None, 16, 16, 256)  590080      conv4_block2_1_relu[0][0]        
__________________________________________________________________________________________________
conv4_block2_2_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block2_2_conv[0][0]        
__________________________________________________________________________________________________
conv4_block2_2_relu (Activation (None, 16, 16, 256)  0           conv4_block2_2_bn[0][0]          
__________________________________________________________________________________________________
conv4_block2_3_conv (Conv2D)    (None, 16, 16, 1024) 263168      conv4_block2_2_relu[0][0]        
__________________________________________________________________________________________________
conv4_block2_3_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block2_3_conv[0][0]        
__________________________________________________________________________________________________
conv4_block2_add (Add)          (None, 16, 16, 1024) 0           conv4_block1_out[0][0]           
                                                                 conv4_block2_3_bn[0][0]          
__________________________________________________________________________________________________
conv4_block2_out (Activation)   (None, 16, 16, 1024) 0           conv4_block2_add[0][0]           
__________________________________________________________________________________________________
conv4_block3_1_conv (Conv2D)    (None, 16, 16, 256)  262400      conv4_block2_out[0][0]           
__________________________________________________________________________________________________
conv4_block3_1_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block3_1_conv[0][0]        
__________________________________________________________________________________________________
conv4_block3_1_relu (Activation (None, 16, 16, 256)  0           conv4_block3_1_bn[0][0]          
__________________________________________________________________________________________________
conv4_block3_2_conv (Conv2D)    (None, 16, 16, 256)  590080      conv4_block3_1_relu[0][0]        
__________________________________________________________________________________________________
conv4_block3_2_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block3_2_conv[0][0]        
__________________________________________________________________________________________________
conv4_block3_2_relu (Activation (None, 16, 16, 256)  0           conv4_block3_2_bn[0][0]          
__________________________________________________________________________________________________
conv4_block3_3_conv (Conv2D)    (None, 16, 16, 1024) 263168      conv4_block3_2_relu[0][0]        
__________________________________________________________________________________________________
conv4_block3_3_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block3_3_conv[0][0]        
__________________________________________________________________________________________________
conv4_block3_add (Add)          (None, 16, 16, 1024) 0           conv4_block2_out[0][0]           
                                                                 conv4_block3_3_bn[0][0]          
__________________________________________________________________________________________________
conv4_block3_out (Activation)   (None, 16, 16, 1024) 0           conv4_block3_add[0][0]           
__________________________________________________________________________________________________
conv4_block4_1_conv (Conv2D)    (None, 16, 16, 256)  262400      conv4_block3_out[0][0]           
__________________________________________________________________________________________________
conv4_block4_1_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block4_1_conv[0][0]        
__________________________________________________________________________________________________
conv4_block4_1_relu (Activation (None, 16, 16, 256)  0           conv4_block4_1_bn[0][0]          
__________________________________________________________________________________________________
conv4_block4_2_conv (Conv2D)    (None, 16, 16, 256)  590080      conv4_block4_1_relu[0][0]        
__________________________________________________________________________________________________
conv4_block4_2_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block4_2_conv[0][0]        
__________________________________________________________________________________________________
conv4_block4_2_relu (Activation (None, 16, 16, 256)  0           conv4_block4_2_bn[0][0]          
__________________________________________________________________________________________________
conv4_block4_3_conv (Conv2D)    (None, 16, 16, 1024) 263168      conv4_block4_2_relu[0][0]        
__________________________________________________________________________________________________
conv4_block4_3_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block4_3_conv[0][0]        
__________________________________________________________________________________________________
conv4_block4_add (Add)          (None, 16, 16, 1024) 0           conv4_block3_out[0][0]           
                                                                 conv4_block4_3_bn[0][0]          
__________________________________________________________________________________________________
conv4_block4_out (Activation)   (None, 16, 16, 1024) 0           conv4_block4_add[0][0]           
__________________________________________________________________________________________________
conv4_block5_1_conv (Conv2D)    (None, 16, 16, 256)  262400      conv4_block4_out[0][0]           
__________________________________________________________________________________________________
conv4_block5_1_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block5_1_conv[0][0]        
__________________________________________________________________________________________________
conv4_block5_1_relu (Activation (None, 16, 16, 256)  0           conv4_block5_1_bn[0][0]          
__________________________________________________________________________________________________
conv4_block5_2_conv (Conv2D)    (None, 16, 16, 256)  590080      conv4_block5_1_relu[0][0]        
__________________________________________________________________________________________________
conv4_block5_2_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block5_2_conv[0][0]        
__________________________________________________________________________________________________
conv4_block5_2_relu (Activation (None, 16, 16, 256)  0           conv4_block5_2_bn[0][0]          
__________________________________________________________________________________________________
conv4_block5_3_conv (Conv2D)    (None, 16, 16, 1024) 263168      conv4_block5_2_relu[0][0]        
__________________________________________________________________________________________________
conv4_block5_3_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block5_3_conv[0][0]        
__________________________________________________________________________________________________
conv4_block5_add (Add)          (None, 16, 16, 1024) 0           conv4_block4_out[0][0]           
                                                                 conv4_block5_3_bn[0][0]          
__________________________________________________________________________________________________
conv4_block5_out (Activation)   (None, 16, 16, 1024) 0           conv4_block5_add[0][0]           
__________________________________________________________________________________________________
conv4_block6_1_conv (Conv2D)    (None, 16, 16, 256)  262400      conv4_block5_out[0][0]           
__________________________________________________________________________________________________
conv4_block6_1_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block6_1_conv[0][0]        
__________________________________________________________________________________________________
conv4_block6_1_relu (Activation (None, 16, 16, 256)  0           conv4_block6_1_bn[0][0]          
__________________________________________________________________________________________________
conv4_block6_2_conv (Conv2D)    (None, 16, 16, 256)  590080      conv4_block6_1_relu[0][0]        
__________________________________________________________________________________________________
conv4_block6_2_bn (BatchNormali (None, 16, 16, 256)  1024        conv4_block6_2_conv[0][0]        
__________________________________________________________________________________________________
conv4_block6_2_relu (Activation (None, 16, 16, 256)  0           conv4_block6_2_bn[0][0]          
__________________________________________________________________________________________________
conv4_block6_3_conv (Conv2D)    (None, 16, 16, 1024) 263168      conv4_block6_2_relu[0][0]        
__________________________________________________________________________________________________
conv4_block6_3_bn (BatchNormali (None, 16, 16, 1024) 4096        conv4_block6_3_conv[0][0]        
__________________________________________________________________________________________________
conv4_block6_add (Add)          (None, 16, 16, 1024) 0           conv4_block5_out[0][0]           
                                                                 conv4_block6_3_bn[0][0]          
__________________________________________________________________________________________________
conv4_block6_out (Activation)   (None, 16, 16, 1024) 0           conv4_block6_add[0][0]           
__________________________________________________________________________________________________
conv5_block1_1_conv (Conv2D)    (None, 8, 8, 512)    524800      conv4_block6_out[0][0]           
__________________________________________________________________________________________________
conv5_block1_1_bn (BatchNormali (None, 8, 8, 512)    2048        conv5_block1_1_conv[0][0]        
__________________________________________________________________________________________________
conv5_block1_1_relu (Activation (None, 8, 8, 512)    0           conv5_block1_1_bn[0][0]          
__________________________________________________________________________________________________
conv5_block1_2_conv (Conv2D)    (None, 8, 8, 512)    2359808     conv5_block1_1_relu[0][0]        
__________________________________________________________________________________________________
conv5_block1_2_bn (BatchNormali (None, 8, 8, 512)    2048        conv5_block1_2_conv[0][0]        
__________________________________________________________________________________________________
conv5_block1_2_relu (Activation (None, 8, 8, 512)    0           conv5_block1_2_bn[0][0]          
__________________________________________________________________________________________________
conv5_block1_0_conv (Conv2D)    (None, 8, 8, 2048)   2099200     conv4_block6_out[0][0]           
__________________________________________________________________________________________________
conv5_block1_3_conv (Conv2D)    (None, 8, 8, 2048)   1050624     conv5_block1_2_relu[0][0]        
__________________________________________________________________________________________________
conv5_block1_0_bn (BatchNormali (None, 8, 8, 2048)   8192        conv5_block1_0_conv[0][0]        
__________________________________________________________________________________________________
conv5_block1_3_bn (BatchNormali (None, 8, 8, 2048)   8192        conv5_block1_3_conv[0][0]        
__________________________________________________________________________________________________
conv5_block1_add (Add)          (None, 8, 8, 2048)   0           conv5_block1_0_bn[0][0]          
                                                                 conv5_block1_3_bn[0][0]          
__________________________________________________________________________________________________
conv5_block1_out (Activation)   (None, 8, 8, 2048)   0           conv5_block1_add[0][0]           
__________________________________________________________________________________________________
conv5_block2_1_conv (Conv2D)    (None, 8, 8, 512)    1049088     conv5_block1_out[0][0]           
__________________________________________________________________________________________________
conv5_block2_1_bn (BatchNormali (None, 8, 8, 512)    2048        conv5_block2_1_conv[0][0]        
__________________________________________________________________________________________________
conv5_block2_1_relu (Activation (None, 8, 8, 512)    0           conv5_block2_1_bn[0][0]          
__________________________________________________________________________________________________
conv5_block2_2_conv (Conv2D)    (None, 8, 8, 512)    2359808     conv5_block2_1_relu[0][0]        
__________________________________________________________________________________________________
conv5_block2_2_bn (BatchNormali (None, 8, 8, 512)    2048        conv5_block2_2_conv[0][0]        
__________________________________________________________________________________________________
conv5_block2_2_relu (Activation (None, 8, 8, 512)    0           conv5_block2_2_bn[0][0]          
__________________________________________________________________________________________________
conv5_block2_3_conv (Conv2D)    (None, 8, 8, 2048)   1050624     conv5_block2_2_relu[0][0]        
__________________________________________________________________________________________________
conv5_block2_3_bn (BatchNormali (None, 8, 8, 2048)   8192        conv5_block2_3_conv[0][0]        
__________________________________________________________________________________________________
conv5_block2_add (Add)          (None, 8, 8, 2048)   0           conv5_block1_out[0][0]           
                                                                 conv5_block2_3_bn[0][0]          
__________________________________________________________________________________________________
conv5_block2_out (Activation)   (None, 8, 8, 2048)   0           conv5_block2_add[0][0]           
__________________________________________________________________________________________________
conv5_block3_1_conv (Conv2D)    (None, 8, 8, 512)    1049088     conv5_block2_out[0][0]           
__________________________________________________________________________________________________
conv5_block3_1_bn (BatchNormali (None, 8, 8, 512)    2048        conv5_block3_1_conv[0][0]        
__________________________________________________________________________________________________
conv5_block3_1_relu (Activation (None, 8, 8, 512)    0           conv5_block3_1_bn[0][0]          
__________________________________________________________________________________________________
conv5_block3_2_conv (Conv2D)    (None, 8, 8, 512)    2359808     conv5_block3_1_relu[0][0]        
__________________________________________________________________________________________________
conv5_block3_2_bn (BatchNormali (None, 8, 8, 512)    2048        conv5_block3_2_conv[0][0]        
__________________________________________________________________________________________________
conv5_block3_2_relu (Activation (None, 8, 8, 512)    0           conv5_block3_2_bn[0][0]          
__________________________________________________________________________________________________
conv5_block3_3_conv (Conv2D)    (None, 8, 8, 2048)   1050624     conv5_block3_2_relu[0][0]        
__________________________________________________________________________________________________
conv5_block3_3_bn (BatchNormali (None, 8, 8, 2048)   8192        conv5_block3_3_conv[0][0]        
__________________________________________________________________________________________________
conv5_block3_add (Add)          (None, 8, 8, 2048)   0           conv5_block2_out[0][0]           
                                                                 conv5_block3_3_bn[0][0]          
__________________________________________________________________________________________________
conv5_block3_out (Activation)   (None, 8, 8, 2048)   0           conv5_block3_add[0][0]           
__________________________________________________________________________________________________
C5_reduced (Conv2D)             (None, 8, 8, 256)    524544      conv5_block3_out[0][0]           
__________________________________________________________________________________________________
C4_reduced (Conv2D)             (None, 16, 16, 256)  262400      conv4_block6_out[0][0]           
__________________________________________________________________________________________________
P5_upsampled (UpSampling2D)     (None, 16, 16, 256)  0           C5_reduced[0][0]                 
__________________________________________________________________________________________________
P4_merged (Add)                 (None, 16, 16, 256)  0           C4_reduced[0][0]                 
                                                                 P5_upsampled[0][0]               
__________________________________________________________________________________________________
C3_reduced (Conv2D)             (None, 32, 32, 256)  131328      conv3_block4_out[0][0]           
__________________________________________________________________________________________________
P4_upsampled (UpSampling2D)     (None, 32, 32, 256)  0           P4_merged[0][0]                  
__________________________________________________________________________________________________
P3_merged (Add)                 (None, 32, 32, 256)  0           C3_reduced[0][0]                 
                                                                 P4_upsampled[0][0]               
__________________________________________________________________________________________________
P3 (Conv2D)                     (None, 32, 32, 256)  590080      P3_merged[0][0]                  
__________________________________________________________________________________________________
conv_0_semantic_upsample_0 (Con (None, 32, 32, 64)   147520      P3[0][0]                         
__________________________________________________________________________________________________
conv_0_semantic_upsample_1 (Con (None, 32, 32, 64)   147520      P3[0][0]                         
__________________________________________________________________________________________________
conv_0_semantic_upsample_2 (Con (None, 32, 32, 64)   147520      P3[0][0]                         
__________________________________________________________________________________________________
upsampling_0_semantic_upsample_ (None, 64, 64, 64)   0           conv_0_semantic_upsample_0[0][0] 
__________________________________________________________________________________________________
upsampling_0_semantic_upsample_ (None, 64, 64, 64)   0           conv_0_semantic_upsample_1[0][0] 
__________________________________________________________________________________________________
upsampling_0_semantic_upsample_ (None, 64, 64, 64)   0           conv_0_semantic_upsample_2[0][0] 
__________________________________________________________________________________________________
conv_1_semantic_upsample_0 (Con (None, 64, 64, 64)   36928       upsampling_0_semantic_upsample_0[
__________________________________________________________________________________________________
conv_1_semantic_upsample_1 (Con (None, 64, 64, 64)   36928       upsampling_0_semantic_upsample_1[
__________________________________________________________________________________________________
conv_1_semantic_upsample_2 (Con (None, 64, 64, 64)   36928       upsampling_0_semantic_upsample_2[
__________________________________________________________________________________________________
upsampling_1_semantic_upsample_ (None, 128, 128, 64) 0           conv_1_semantic_upsample_0[0][0] 
__________________________________________________________________________________________________
upsampling_1_semantic_upsample_ (None, 128, 128, 64) 0           conv_1_semantic_upsample_1[0][0] 
__________________________________________________________________________________________________
upsampling_1_semantic_upsample_ (None, 128, 128, 64) 0           conv_1_semantic_upsample_2[0][0] 
__________________________________________________________________________________________________
conv_2_semantic_upsample_0 (Con (None, 128, 128, 64) 36928       upsampling_1_semantic_upsample_0[
__________________________________________________________________________________________________
conv_2_semantic_upsample_1 (Con (None, 128, 128, 64) 36928       upsampling_1_semantic_upsample_1[
__________________________________________________________________________________________________
conv_2_semantic_upsample_2 (Con (None, 128, 128, 64) 36928       upsampling_1_semantic_upsample_2[
__________________________________________________________________________________________________
upsampling_2_semantic_upsample_ (None, 256, 256, 64) 0           conv_2_semantic_upsample_0[0][0] 
__________________________________________________________________________________________________
upsampling_2_semantic_upsample_ (None, 256, 256, 64) 0           conv_2_semantic_upsample_1[0][0] 
__________________________________________________________________________________________________
upsampling_2_semantic_upsample_ (None, 256, 256, 64) 0           conv_2_semantic_upsample_2[0][0] 
__________________________________________________________________________________________________
conv_0_semantic_0 (Conv2D)      (None, 256, 256, 128 8320        upsampling_2_semantic_upsample_0[
__________________________________________________________________________________________________
conv_0_semantic_1 (Conv2D)      (None, 256, 256, 128 8320        upsampling_2_semantic_upsample_1[
__________________________________________________________________________________________________
conv_0_semantic_2 (Conv2D)      (None, 256, 256, 128 8320        upsampling_2_semantic_upsample_2[
__________________________________________________________________________________________________
batch_normalization_0_semantic_ (None, 256, 256, 128 512         conv_0_semantic_0[0][0]          
__________________________________________________________________________________________________
batch_normalization_0_semantic_ (None, 256, 256, 128 512         conv_0_semantic_1[0][0]          
__________________________________________________________________________________________________
batch_normalization_0_semantic_ (None, 256, 256, 128 512         conv_0_semantic_2[0][0]          
__________________________________________________________________________________________________
relu_0_semantic_0 (Activation)  (None, 256, 256, 128 0           batch_normalization_0_semantic_0[
__________________________________________________________________________________________________
relu_0_semantic_1 (Activation)  (None, 256, 256, 128 0           batch_normalization_0_semantic_1[
__________________________________________________________________________________________________
relu_0_semantic_2 (Activation)  (None, 256, 256, 128 0           batch_normalization_0_semantic_2[
__________________________________________________________________________________________________
conv_1_semantic_0 (Conv2D)      (None, 256, 256, 1)  129         relu_0_semantic_0[0][0]          
__________________________________________________________________________________________________
conv_1_semantic_1 (Conv2D)      (None, 256, 256, 1)  129         relu_0_semantic_1[0][0]          
__________________________________________________________________________________________________
conv_1_semantic_2 (Conv2D)      (None, 256, 256, 1)  129         relu_0_semantic_2[0][0]          
__________________________________________________________________________________________________
head (Activation)               (None, 256, 256, 1)  0           conv_1_semantic_0[0][0]          
__________________________________________________________________________________________________
abdomen (Activation)            (None, 256, 256, 1)  0           conv_1_semantic_1[0][0]          
__________________________________________________________________________________________________
thorax (Activation)             (None, 256, 256, 1)  0           conv_1_semantic_2[0][0]          
==================================================================================================
Total params: 25,787,087
Trainable params: 25,733,199
Non-trainable params: 53,888
__________________________________________________________________________________________________
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="train-model">
<h2>Train Model<a class="headerlink" href="#train-model" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.losses</span> <span class="kn">import</span> <span class="n">MSE</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adam</span>

<span class="c1"># Define loss functions</span>
<span class="n">loss</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">bug_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;abdomen&#39;</span><span class="p">,</span> <span class="s1">&#39;thorax&#39;</span><span class="p">]:</span>
        <span class="n">loss</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSE</span>
        
<span class="c1"># Define training parameters</span>
<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

<span class="c1"># Compile model</span>
<span class="n">bug_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define callbacks</span>
<span class="n">bug_model_path</span> <span class="o">=</span> <span class="s1">&#39;/notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5&#39;</span>

<span class="n">bug_callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
                 <span class="n">bug_model_path</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                 <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">]</span>

<span class="n">bug_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                     <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
                     <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train model</span>
<span class="n">loss_history</span> <span class="o">=</span> <span class="n">bug_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">bug_data</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                             <span class="n">validation_data</span><span class="o">=</span><span class="n">bug_data</span><span class="o">.</span><span class="n">val_dataset</span><span class="p">,</span>
                             <span class="n">epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">callbacks</span><span class="o">=</span><span class="n">bug_callbacks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/16
85/85 [==============================] - 41s 293ms/step - loss: 0.1795 - head_loss: 0.0184 - abdomen_loss: 0.1233 - thorax_loss: 0.0378 - val_loss: 0.0633 - val_head_loss: 0.0210 - val_abdomen_loss: 0.0214 - val_thorax_loss: 0.0209

Epoch 00001: val_loss improved from inf to 0.06329, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 2/16
85/85 [==============================] - 22s 259ms/step - loss: 0.0092 - head_loss: 0.0033 - abdomen_loss: 0.0032 - thorax_loss: 0.0027 - val_loss: 0.0576 - val_head_loss: 0.0198 - val_abdomen_loss: 0.0183 - val_thorax_loss: 0.0195

Epoch 00002: val_loss improved from 0.06329 to 0.05757, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 3/16
85/85 [==============================] - 22s 260ms/step - loss: 0.0056 - head_loss: 0.0020 - abdomen_loss: 0.0019 - thorax_loss: 0.0017 - val_loss: 0.0507 - val_head_loss: 0.0161 - val_abdomen_loss: 0.0183 - val_thorax_loss: 0.0163

Epoch 00003: val_loss improved from 0.05757 to 0.05072, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 4/16
85/85 [==============================] - 23s 265ms/step - loss: 0.0051 - head_loss: 0.0018 - abdomen_loss: 0.0019 - thorax_loss: 0.0014 - val_loss: 0.0539 - val_head_loss: 0.0182 - val_abdomen_loss: 0.0180 - val_thorax_loss: 0.0178

Epoch 00004: val_loss did not improve from 0.05072
Epoch 5/16
85/85 [==============================] - 22s 262ms/step - loss: 0.0045 - head_loss: 0.0017 - abdomen_loss: 0.0015 - thorax_loss: 0.0013 - val_loss: 0.0455 - val_head_loss: 0.0144 - val_abdomen_loss: 0.0166 - val_thorax_loss: 0.0146

Epoch 00005: val_loss improved from 0.05072 to 0.04548, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 6/16
85/85 [==============================] - 22s 264ms/step - loss: 0.0037 - head_loss: 0.0013 - abdomen_loss: 0.0013 - thorax_loss: 0.0011 - val_loss: 0.0353 - val_head_loss: 0.0117 - val_abdomen_loss: 0.0114 - val_thorax_loss: 0.0122

Epoch 00006: val_loss improved from 0.04548 to 0.03531, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 7/16
85/85 [==============================] - 22s 263ms/step - loss: 0.0034 - head_loss: 0.0013 - abdomen_loss: 0.0011 - thorax_loss: 9.7032e-04 - val_loss: 0.0381 - val_head_loss: 0.0113 - val_abdomen_loss: 0.0137 - val_thorax_loss: 0.0131

Epoch 00007: val_loss did not improve from 0.03531
Epoch 8/16
85/85 [==============================] - 23s 266ms/step - loss: 0.0032 - head_loss: 0.0011 - abdomen_loss: 0.0011 - thorax_loss: 9.0177e-04 - val_loss: 0.0258 - val_head_loss: 0.0077 - val_abdomen_loss: 0.0095 - val_thorax_loss: 0.0085

Epoch 00008: val_loss improved from 0.03531 to 0.02577, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 9/16
85/85 [==============================] - 22s 263ms/step - loss: 0.0026 - head_loss: 9.4825e-04 - abdomen_loss: 8.6283e-04 - thorax_loss: 7.4661e-04 - val_loss: 0.0117 - val_head_loss: 0.0036 - val_abdomen_loss: 0.0048 - val_thorax_loss: 0.0034

Epoch 00009: val_loss improved from 0.02577 to 0.01174, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 10/16
85/85 [==============================] - 22s 264ms/step - loss: 0.0029 - head_loss: 0.0010 - abdomen_loss: 9.8917e-04 - thorax_loss: 8.6413e-04 - val_loss: 0.0055 - val_head_loss: 0.0019 - val_abdomen_loss: 0.0021 - val_thorax_loss: 0.0015

Epoch 00010: val_loss improved from 0.01174 to 0.00547, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 11/16
85/85 [==============================] - 23s 266ms/step - loss: 0.0023 - head_loss: 8.2611e-04 - abdomen_loss: 8.1147e-04 - thorax_loss: 7.0860e-04 - val_loss: 0.0030 - val_head_loss: 0.0012 - val_abdomen_loss: 0.0011 - val_thorax_loss: 7.4795e-04

Epoch 00011: val_loss improved from 0.00547 to 0.00305, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 12/16
85/85 [==============================] - 22s 263ms/step - loss: 0.0027 - head_loss: 9.6934e-04 - abdomen_loss: 9.1597e-04 - thorax_loss: 7.8951e-04 - val_loss: 0.0028 - val_head_loss: 0.0010 - val_abdomen_loss: 0.0011 - val_thorax_loss: 7.0343e-04

Epoch 00012: val_loss improved from 0.00305 to 0.00283, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 13/16
85/85 [==============================] - 22s 263ms/step - loss: 0.0025 - head_loss: 8.9262e-04 - abdomen_loss: 8.5808e-04 - thorax_loss: 7.5898e-04 - val_loss: 0.0028 - val_head_loss: 0.0010 - val_abdomen_loss: 7.3291e-04 - val_thorax_loss: 0.0010

Epoch 00013: val_loss improved from 0.00283 to 0.00281, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 14/16
85/85 [==============================] - 22s 262ms/step - loss: 0.0023 - head_loss: 8.6177e-04 - abdomen_loss: 7.9405e-04 - thorax_loss: 6.8307e-04 - val_loss: 0.0016 - val_head_loss: 6.5850e-04 - val_abdomen_loss: 5.4169e-04 - val_thorax_loss: 4.1833e-04

Epoch 00014: val_loss improved from 0.00281 to 0.00162, saving model to /notebooks/bebi205-sandbox/beetles/spot-detection-beetles.h5
Epoch 15/16
85/85 [==============================] - 22s 262ms/step - loss: 0.0020 - head_loss: 7.1179e-04 - abdomen_loss: 6.9006e-04 - thorax_loss: 5.7563e-04 - val_loss: 0.0021 - val_head_loss: 8.0776e-04 - val_abdomen_loss: 6.9747e-04 - val_thorax_loss: 5.6267e-04

Epoch 00015: val_loss did not improve from 0.00162
Epoch 16/16
85/85 [==============================] - 23s 264ms/step - loss: 0.0020 - head_loss: 6.8609e-04 - abdomen_loss: 7.2187e-04 - thorax_loss: 5.8270e-04 - val_loss: 0.0018 - val_head_loss: 6.4838e-04 - val_abdomen_loss: 6.8829e-04 - val_thorax_loss: 5.0822e-04

Epoch 00016: val_loss did not improve from 0.00162
</pre></div>
</div>
</div>
</div>
</section>
<section id="generate-predictions">
<h2>Generate predictions<a class="headerlink" href="#generate-predictions" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">bug_data</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize predictions</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">nd</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">watershed</span><span class="p">,</span> <span class="n">remove_small_objects</span><span class="p">,</span> <span class="n">h_maxima</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">square</span><span class="p">,</span> <span class="n">dilation</span><span class="p">,</span> <span class="n">local_maxima</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">peak_local_max</span>

<span class="k">def</span> <span class="nf">post_processing</span><span class="p">(</span><span class="n">transform_img</span><span class="p">):</span>
    <span class="n">max_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transform_img</span> <span class="o">=</span> <span class="n">transform_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transform_img</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">transform_img</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">maxima</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">transform_img</span><span class="p">,</span>
                            <span class="n">min_distance</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">threshold_abs</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                            <span class="n">exclude_border</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">maxima</span>
    

<span class="n">X_dict</span><span class="p">,</span> <span class="n">y_true_dict</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">test_iter</span><span class="p">)</span>
<span class="n">y_pred_list</span> <span class="o">=</span> <span class="n">bug_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>

<span class="n">head_markers</span> <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
<span class="n">abdomen_markers</span> <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
<span class="n">thorax_markers</span> <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>

<span class="n">head_markers_true</span> <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
<span class="n">abdomen_markers_true</span> <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
<span class="n">thorax_markers_true</span>  <span class="o">=</span> <span class="n">post_processing</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;thorax&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">head_markers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">abdomen_markers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">thorax_markers</span><span class="p">)</span>

<span class="n">y_pred_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;head&#39;</span><span class="p">:</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="s1">&#39;abdomen&#39;</span><span class="p">:</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="s1">&#39;thorax&#39;</span><span class="p">:</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">head_markers</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">head_markers</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">abdomen_markers</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">abdomen_markers</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">thorax_markers</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">thorax_markers</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_pred_dict</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_pred_dict</span><span class="p">[</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_pred_dict</span><span class="p">[</span><span class="s1">&#39;thorax&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">head_markers_true</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">head_markers_true</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">abdomen_markers_true</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">abdomen_markers_true</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">thorax_markers_true</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">thorax_markers_true</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;thorax&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[163 156]
 [ 85 127]]
[[ 65 103]
 [143 163]]
[[159 158]
 [ 81 120]]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7fab20e87ef0&gt;
</pre></div>
</div>
<img alt="../_images/e09917b1f248f5493981fe8207e781dc4e0d2f6585738e2e19148e9dd53c1a0c.png" src="../_images/e09917b1f248f5493981fe8207e781dc4e0d2f6585738e2e19148e9dd53c1a0c.png" />
</div>
</div>
</section>
<section id="benchmark-model-performance">
<h2>Benchmark model performance<a class="headerlink" href="#benchmark-model-performance" title="Permalink to this heading">#</a></h2>
<p>Collect a set of samples from the test dataset in order to benchmark model performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">X_dict</span><span class="p">,</span> <span class="n">y_true_dict</span> <span class="ow">in</span> <span class="n">bug_data</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">:</span>
    <span class="n">y_pred_list</span> <span class="o">=</span> <span class="n">bug_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
    
    <span class="c1"># Extract predicted points</span>
    <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_processing</span><span class="p">(</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_processing</span><span class="p">(</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_processing</span><span class="p">(</span><span class="n">y_pred_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>

    <span class="c1"># Extract true points from transformed images</span>
    <span class="n">y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_processing</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_processing</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;abdomen&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_processing</span><span class="p">(</span><span class="n">y_true_dict</span><span class="p">[</span><span class="s1">&#39;thorax&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    
<span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">linear_sum_assignment</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>

<span class="k">def</span> <span class="nf">sum_of_min_distance</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the sum of minimal distance measure between two sets of d-dimensional points</span>
<span class="sd">    as suggested by Eiter and Mannila in:</span>
<span class="sd">    https://link.springer.com/article/10.1007/s002360050075</span>
<span class="sd">    Args:</span>
<span class="sd">       pts1 ((N1,d) numpy.array): set of N1 points in d dimensions</span>
<span class="sd">       pts2 ((N2,d) numpy.array): set of N2 points in d dimensions</span>
<span class="sd">           each row of pts1 and pts2 should be the coordinates of a single d-dimensional point</span>
<span class="sd">       normalized (bool): if true, each sum will be normalized by the number of elements in it,</span>
<span class="sd">           resulting in an intensive distance measure which doesn&#39;t scale like the number of points</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: the sum of minimal distance between point sets X and Y, defined as:</span>
<span class="sd">        d(X,Y) = 1/2 * (sum over x in X of min on y in Y of d(x,y)</span>
<span class="sd">        + sum over y in Y of min on x in X of d(x,y))</span>
<span class="sd">        = 1/2( sum over x in X of d(x,Y) + sum over y in Y of d(X,y))</span>
<span class="sd">        where d(x,y) is the Euclidean distance</span>
<span class="sd">        Note that this isn&#39;t a metric in the mathematical sense (it doesn&#39;t satisfy the triangle</span>
<span class="sd">        inequality)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># for each point in each of the sets, find its nearest neighbor from the other set</span>
    <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dist21</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree1</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span>
    <span class="n">tree2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">pts2</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dist12</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree2</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pts1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalized</span><span class="p">:</span>
        <span class="n">d_md</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist21</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist12</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_md</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist21</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist12</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d_md</span>

<span class="k">def</span> <span class="nf">match_points_mutual_nearest_neighbor</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Find a pairing between two sets of points that ensures that each pair of points are mutual nearest neighbors. </span>
<span class="sd">    Args:</span>
<span class="sd">        pts1 ((N1,d) numpy.array): a set of N1 points in d dimensions</span>
<span class="sd">        pts2 ((N2,d) numpy.array): a set of N2 points in d dimensions</span>
<span class="sd">            where N1/N2 is the number of points and d is the dimension</span>
<span class="sd">        threshold (float): a distance threshold for matching two points. Points that are more than the threshold</span>
<span class="sd">        distance apart, cannot be matched</span>
<span class="sd">    Returns:</span>
<span class="sd">        row_ind, col_ind (arrays):</span>
<span class="sd">        An array of row indices and one of corresponding column indices giving the optimal assignment, as described in:</span>
<span class="sd">        https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.linear_sum_assignment.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># calculate the distances between true points and their nearest predicted points</span>
    <span class="c1"># and the distances between predicted points and their nearest true points</span>
    <span class="n">tree1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dist_to_nearest1</span><span class="p">,</span> <span class="n">nearest_ind1</span> <span class="o">=</span> <span class="n">tree1</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span>
    <span class="c1"># dist_to_nearest1[i] is the distance between pts1 point i and the pts2 point closest to it</span>
    <span class="c1"># nearest_ind1[i] is equal to j if pts1[j] is the nearest to pts2[i] from all of pts1</span>
    <span class="n">tree2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">pts2</span><span class="p">,</span> <span class="n">leafsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dist_to_nearest2</span><span class="p">,</span> <span class="n">nearest_ind2</span> <span class="o">=</span> <span class="n">tree2</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pts1</span><span class="p">)</span>
    <span class="c1"># dist_to_nearest2[i] is the distance between pts2 point i and the pts1 point nearest to it</span>
    <span class="c1"># nearest_ind2[i] is equal to j if pts2[j] is the nearest to pts1[i] from all of pts2</span>

    <span class="c1"># calculate the number of true positives</span>
    <span class="n">pt_has_mutual_nn2</span> <span class="o">=</span> <span class="n">nearest_ind2</span><span class="p">[</span><span class="n">nearest_ind1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nearest_ind1</span><span class="p">)))</span>
    <span class="n">pt_has_mutual_nn1</span> <span class="o">=</span> <span class="n">nearest_ind1</span><span class="p">[</span><span class="n">nearest_ind2</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nearest_ind2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pt_has_mutual_nn1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">col_ind</span> <span class="o">=</span> <span class="n">nearest_ind2</span><span class="p">[</span><span class="n">pt_has_mutual_nn1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_close_enough_to_nn1</span> <span class="o">=</span> <span class="n">dist_to_nearest2</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
        <span class="n">matched_pts1</span> <span class="o">=</span> <span class="n">pt_has_mutual_nn1</span> <span class="o">&amp;</span> <span class="n">pt_close_enough_to_nn1</span>
        <span class="n">col_ind</span> <span class="o">=</span> <span class="n">nearest_ind2</span><span class="p">[</span><span class="n">matched_pts1</span><span class="p">]</span>
        <span class="n">row_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matched_pts1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span>


<span class="k">def</span> <span class="nf">point_precision</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">match_points_function</span><span class="o">=</span><span class="n">match_points_mutual_nearest_neighbor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculates the precision, tp/(tp + fp), of point detection using the following definitions:</span>
<span class="sd">    true positive (tp) = a predicted dot p with a matching true dot t,</span>
<span class="sd">    where the matching between predicted and true points is such that the total distance between matched points is</span>
<span class="sd">    minimized, and points can be matched only if the distance between them is smaller than the threshold.</span>
<span class="sd">    Otherwise, the predicted dot is a false positive (fp).</span>
<span class="sd">    The precision is equal to (the number of true positives) / (total number of predicted points)</span>
<span class="sd">    Args:</span>
<span class="sd">        points_true ((N1,d) numpy.array): ground truth points for a single image</span>
<span class="sd">        points_pred ((N2,d) numpy.array): predicted points for a single image</span>
<span class="sd">            where N1/N2 is the number of points and d is the dimension</span>
<span class="sd">        threshold (float): a distance threshold used in the definition of tp and fp</span>
<span class="sd">        match_points_function: a function that matches points in two sets,</span>
<span class="sd">        and has three parameters: pts1, pts2, threshold -</span>
<span class="sd">        two sets of points, and a threshold distance for allowing a match</span>
<span class="sd">        supported matching functions are match_points_min_dist, match_points_mutual_nearest_neighbor</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: the precision as defined above (a number between 0 and 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_true</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># find the minimal sum of distances matching between the points</span>
    <span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="n">match_points_function</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

    <span class="c1"># number of true positives = number of pairs matched</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_ind</span><span class="p">)</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">precision</span>


<span class="k">def</span> <span class="nf">point_recall</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">match_points_function</span><span class="o">=</span><span class="n">match_points_mutual_nearest_neighbor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the recall, tp/(tp + fn), of point detection using the following definitions:</span>
<span class="sd">    true positive (tp) = a predicted dot p with a matching true dot t,</span>
<span class="sd">    where the matching between predicted and true points is such that the total distance between matched points is</span>
<span class="sd">    minimized, and points can be matched only if the distance between them is smaller than the threshold.</span>
<span class="sd">    Otherwise, the predicted dot is a false positive (fp).</span>
<span class="sd">    The recall is equal to (the number of true positives) / (total number of true points)</span>
<span class="sd">    Args:</span>
<span class="sd">        points_true ((N1,d) numpy.array): ground truth points for a single image</span>
<span class="sd">        points_pred ((N2,d) numpy.array): predicted points for a single image</span>
<span class="sd">            where N1/N2 is the number of points and d is the dimension</span>
<span class="sd">        threshold (float): a distance threshold used in the definition of tp and fp</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: the recall as defined above (a number between 0 and 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_true</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># find the minimal sum of distances matching between the points</span>
    <span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="n">match_points_function</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

    <span class="c1"># number of true positives = number of pairs matched</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_ind</span><span class="p">)</span>

    <span class="n">recall</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">recall</span>


<span class="k">def</span> <span class="nf">point_F1_score</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">match_points_function</span><span class="o">=</span><span class="n">match_points_mutual_nearest_neighbor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the F1 score of dot detection using the following definitions:</span>
<span class="sd">    F1 score = 2*p*r / (p+r)</span>
<span class="sd">    where</span>
<span class="sd">    p = precision = (the number of true positives) / (total number of predicted points)</span>
<span class="sd">    r = recall = (the number of true positives) / (total number of true points)</span>
<span class="sd">    and</span>
<span class="sd">    true positive (tp) = a predicted dot p with a matching true dot t,</span>
<span class="sd">    where the matching between predicted and true points is such that the total distance between matched points is</span>
<span class="sd">    minimized, and points can be matched only if the distance between them is smaller than the threshold.</span>
<span class="sd">    Otherwise, the predicted dot is a false positive (fp).</span>
<span class="sd">    Args:</span>
<span class="sd">        points_true ((N1,d) numpy.array): ground truth points for a single image</span>
<span class="sd">        points_pred ((N2,d) numpy.array): predicted points for a single image</span>
<span class="sd">            where N1/N2 is the number of points and d is the dimension</span>
<span class="sd">        threshold (float): a distance threshold used in the definition of tp and fp</span>
<span class="sd">    Returns:</span>
<span class="sd">        float: the F1 score as defined above (a number between 0 and 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">point_precision</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">point_recall</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">F1</span>


<span class="k">def</span> <span class="nf">stats_points</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">match_points_function</span><span class="o">=</span><span class="n">match_points_mutual_nearest_neighbor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates point-based statistics</span>
<span class="sd">    (precision, recall, F1, JAC, RMSE, d_md)</span>
<span class="sd">    Args:</span>
<span class="sd">        points_true ((N1,d) numpy.array): ground truth points for a single image</span>
<span class="sd">        points_pred ((N2,d) numpy.array): predicted points for a single image</span>
<span class="sd">            where N1/N2 is the number of points and d is the dimension</span>
<span class="sd">        threshold (float): a distance threshold used in the definition of tp and fp</span>
<span class="sd">    Returns:</span>
<span class="sd">        dictionary: containing the calculated statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if one of the point sets is empty, precision=recall=0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_true</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">J</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">RMSE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dmd</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
            <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="n">F1</span><span class="p">,</span>
            <span class="s1">&#39;JAC&#39;</span><span class="p">:</span> <span class="n">J</span><span class="p">,</span>
            <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">RMSE</span><span class="p">,</span>
            <span class="s1">&#39;d_md&#39;</span><span class="p">:</span> <span class="n">dmd</span>
        <span class="p">}</span>


    <span class="c1"># find the minimal sum of distances matching between the points</span>
    <span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="n">match_points_function</span><span class="p">(</span><span class="n">points_true</span><span class="p">,</span> <span class="n">points_pred</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

    <span class="c1"># number of true positives = number of pairs matched</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_ind</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_pred</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_true</span><span class="p">)</span>

    <span class="c1"># calculate the F1 score from the precision and the recall</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># calculate the Jaccard index from the F1 score</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>

    <span class="c1"># calculate the RMSE for matched pairs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">RMSE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d_md</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist_sq_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points_true</span><span class="p">[</span><span class="n">row_ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">points_pred</span><span class="p">[</span><span class="n">col_ind</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist_sq_sum</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">row_ind</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># RMSE = np.sqrt(mean_squared_error(points_true[row_ind], points_pred[col_ind]))</span>

        <span class="c1"># calculate the mean sum to nearest neighbor from other set</span>
        <span class="n">d_md</span> <span class="o">=</span> <span class="n">sum_of_min_distance</span><span class="p">(</span><span class="n">points_true</span><span class="p">[</span><span class="n">row_ind</span><span class="p">],</span> <span class="n">points_pred</span><span class="p">[</span><span class="n">col_ind</span><span class="p">],</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
        <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="n">F1</span><span class="p">,</span>
        <span class="s1">&#39;Jaccard Index&#39;</span><span class="p">:</span> <span class="n">J</span><span class="p">,</span>
        <span class="s1">&#39;Root Mean Squared Error&#39;</span><span class="p">:</span> <span class="n">RMSE</span><span class="p">,</span>
        <span class="s1">&#39;Average Distance&#39;</span><span class="p">:</span> <span class="n">d_md</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_points</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;precision&#39;: 0.9361702127659575,
 &#39;recall&#39;: 0.7457627118644068,
 &#39;F1&#39;: 0.8301886792452831,
 &#39;Jaccard Index&#39;: 0.7096774193548387,
 &#39;Root Mean Squared Error&#39;: 1.8799177931736561,
 &#39;Average Distance&#39;: 2.241467514540121}
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">watermark</span> -u -d -vm --iversions
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>re                2.2.1
pandas            1.1.5
skimage           0.17.2
numpy             1.19.5
tensorflow_addons 0.12.1
scipy.ndimage     2.0
tensorflow        2.4.1
sklearn           0.24.1
imageio           2.9.0
last updated: 2021-04-27 

CPython 3.6.9
IPython 7.16.1

compiler   : GCC 8.4.0
system     : Linux
release    : 4.15.0-142-generic
machine    : x86_64
processor  : x86_64
CPU cores  : 24
interpreter: 64bit
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../vision-model-toc.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Vision Models</p>
      </div>
    </a>
    <a class="right-next"
       href="segmentation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Vision Models: Cell Segmentation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-dataset-object">Prepare dataset object</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-model">Prepare model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-model">Train Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-predictions">Generate predictions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#benchmark-model-performance">Benchmark model performance</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By David Van Valen, Morgan Schwartz and Rohit Dilip
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>